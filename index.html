<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Avatar Item Forge</title>
  <style>
    :root{
      --bg:#07120f;--grid:#0e1f1a;--panel:#0a1411;--line:#0f2c1f;--neon:#00ff63;--neon-2:#2bffb1;--text:#e5fff1;--muted:#8cc9ad;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(0,255,99,.08), transparent),
                  radial-gradient(1200px 600px at 110% 110%, rgba(0,255,99,.06), transparent),
                  linear-gradient(180deg,#05100d,#0a1512 60%, #06100d);
      color:var(--text);
    }
    .wrap{max-width:1280px;margin:28px auto;padding:0 16px;display:grid;gap:20px;grid-template-columns:1fr;}
    @media(min-width:1100px){.wrap{grid-template-columns:1.2fr .9fr}}

    .stage{
      position:relative;background:linear-gradient(180deg,#0a1411,#0b1713);
      border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.45);
    }
    .stage:before,.stage:after{content:"";position:absolute;inset:8px;border:2px solid rgba(0,255,99,.35);border-radius:12px;pointer-events:none}
    .stage:after{inset:16px;border-color:rgba(0,255,99,.15)}
    .scan{position:absolute;left:0;right:0;top:0;height:2px;background:linear-gradient(90deg,transparent, var(--neon), transparent);opacity:.5;animation:scan 3.6s linear infinite}
    @keyframes scan{0%{transform:translateY(0)}100%{transform:translateY(640px)}}

    .panel{background:linear-gradient(180deg,#0a1411,#0b1713);border:1px solid var(--line);border-radius:16px;padding:16px}
    .panel + .panel{margin-top:10px}
    .title{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.06em}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--neon);box-shadow:0 0 0 3px rgba(0,255,99,.25)}

    .btn{appearance:none;display:inline-flex;align-items:center;justify-content:center;gap:10px;width:100%;
      background:linear-gradient(90deg,var(--neon),var(--neon-2));color:#002b19;border:0;border-radius:12px;padding:14px 16px;
      font-weight:800;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;transition:transform .08s ease, filter .2s ease}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--line)}

    .thumbs{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .thumb{background:#0c1814;border:1px solid var(--line);border-radius:12px;display:flex;align-items:center;justify-content:center;min-height:86px;cursor:pointer;position:relative}
    .thumb.active{outline:2px solid var(--neon)}

    .muted{color:var(--muted);font-size:12px}

    canvas{width:100%;background: #07120f;border:1px dashed rgba(0,255,99,.35);border-radius:12px}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .input, input[type="range"]{width:100%}
    input[type="range"]{accent-color:var(--neon)}
    label{display:block;margin:6px 0;color:var(--muted)}

    .bar{display:flex;gap:10px;margin-top:14px}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="stage" aria-label="Preview Stage">
      <div class="scan"></div>
      <canvas id="c" width="900" height="900" aria-label="Avatar canvas"></canvas>
    </section>

    <section>
      <div class="panel">
        <div class="title"><span class="dot"></span> 01. Upload Avatar</div>
        <p class="muted" style="margin:8px 0 12px">PNG / JPG — we render locally in your browser.</p>
        <input id="photo" type="file" accept="image/*" style="display:none"/>
        <button id="pickPhoto" class="btn">➕ Select Image File</button>
      </div>

      <div class="panel">
        <div class="title"><span class="dot"></span> 02. Select Item</div>
        <div class="thumbs" id="thumbs">
          <div class="thumb" data-mask="cap1" title="Cap A"></div>
          <div class="thumb" data-mask="cap2" title="Cap B"></div>
          <div class="thumb" data-mask="bucket" title="Bucket Hat"></div>
        </div>
        <div class="row">
          <div>
            <label for="scale">Scale</label>
            <input id="scale" type="range" min="0.2" max="3" value="1" step="0.01"/>
          </div>
          <div>
            <label for="rotate">Rotate (°)</label>
            <input id="rotate" type="range" min="-180" max="180" value="0" step="1"/>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="opacity">Opacity</label>
            <input id="opacity" type="range" min="0" max="1" value="1" step="0.01"/>
          </div>
          <div>
            <label for="exportSize">Export Size</label>
            <select id="exportSize" class="input">
              <option value="orig">Original</option>
              <option value="512">512 × 512</option>
              <option value="1024">1024 × 1024</option>
            </select>
          </div>
        </div>
        <div class="bar">
          <button id="download" class="btn">⬇ Download PNG</button>
          <button id="reset" class="btn secondary">↻ Reset System</button>
        </div>
        <p class="muted" style="margin-top:8px">Tip: drag the item on canvas. Arrows move it precisely; [ / ] rotate; - / + scale.</p>
      </div>
    </section>
  </main>

  <script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    const photoInput = document.getElementById('photo');
    const pickPhotoBtn = document.getElementById('pickPhoto');
    const thumbs = document.getElementById('thumbs');

    const scaleInput = document.getElementById('scale');
    const rotateInput = document.getElementById('rotate');
    const opacityInput = document.getElementById('opacity');
    const exportSizeSel = document.getElementById('exportSize');

    const resetBtn = document.getElementById('reset');
    const dlBtn = document.getElementById('download');

    const state = { bgImg:null, capImg:null, cap:{x:0,y:0,w:0,h:0,scale:1,rot:0,alpha:1} };

    function loadImageFromFile(file){return new Promise((res,rej)=>{const url=URL.createObjectURL(file);const img=new Image();img.onload=()=>{URL.revokeObjectURL(url);res(img)};img.onerror=rej;img.src=url;});}
    function fitCanvasToImage(img){const MAX=1400;let w=img.naturalWidth,h=img.naturalHeight;const k=Math.min(1,MAX/Math.max(w,h));canvas.width=Math.round(w*k);canvas.height=Math.round(h*k);}
    function makeNeonSticker(label){const w=280,h=160;const off=document.createElement('canvas');off.width=w;off.height=h;const g=off.getContext('2d');g.fillStyle='#0c1814';g.fillRect(0,0,w,h);g.strokeStyle='rgba(0,255,99,.6)';g.lineWidth=3;g.strokeRect(8,8,w-16,h-16);g.fillStyle='#00ff63';g.font='bold 28px ui-sans-serif,system-ui';g.textAlign='center';g.textBaseline='middle';g.fillText(label,w/2,h/2);return off;}

    const presets={cap1:makeNeonSticker('CAP A'),cap2:makeNeonSticker('CAP B'),bucket:makeNeonSticker('BUCKET HAT')};

    Array.from(thumbs.querySelectorAll('.thumb')).forEach(el=>{const key=el.getAttribute('data-mask');if(!key)return;const img=presets[key];const t=document.createElement('img');t.src=img.toDataURL();t.alt=key;t.style.maxWidth='70%';t.style.opacity=.95;el.appendChild(t);});

    function centerCap(imgLike){const iw=imgLike.width||imgLike.naturalWidth;const ih=imgLike.height||imgLike.naturalHeight;state.cap.w=iw;state.cap.h=ih;state.cap.scale=Math.min(1,canvas.width/iw*0.5);state.cap.rot=0;state.cap.x=canvas.width/2-(iw*state.cap.scale)/2;state.cap.y=canvas.height*0.2;scaleInput.value=String(state.cap.scale);rotateInput.value=String(state.cap.rot);}
    function render(){ctx.clearRect(0,0,canvas.width,canvas.height);if(state.bgImg){ctx.drawImage(state.bgImg,0,0,canvas.width,canvas.height);}else{ctx.fillStyle='#07120f';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.strokeStyle='rgba(0,255,99,.08)';for(let x=0;x<canvas.width;x+=24){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();}for(let y=0;y<canvas.height;y+=24){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}}const capSource=state.capImg||presets.cap1;const {x,y,w,h,scale,rot,alpha}=state.cap;const cw=w*scale,ch=h*scale;const cx=x+cw/2,cy=y+ch/2;ctx.save();ctx.translate(cx,cy);ctx.rotate(rot*Math.PI/180);ctx.globalAlpha=alpha;ctx.drawImage(capSource,-cw/2,-ch/2,cw,ch);ctx.restore();ctx.globalAlpha=1;}

    let dragging=false;let dragOff={x:0,y:0};
    function hitCap(mx,my){const{x,y,w,h,scale,rot}=state.cap;const cw=w*scale,ch=h*scale;const cx=x+cw/2,cy=y+ch/2;const dx=mx-cx,dy=my-cy;const ang=-rot*Math.PI/180;const rx=dx*Math.cos(ang)-dy*Math.sin(ang);const ry=dx*Math.sin(ang)+dy*Math.cos(ang);return(rx>=-cw/2&&rx<=cw/2&&ry>=-ch/2&&ry<=ch/2);}
    canvas.addEventListener('mousedown',e=>{const r=canvas.getBoundingClientRect();const mx=(e.clientX-r.left)*(canvas.width/r.width);const my=(e.clientY-r.top)*(canvas.height/r.height);if(hitCap(mx,my)){dragging=true;dragOff.x=mx-state.cap.x;dragOff.y=my-state.cap.y;}});
    window.addEventListener('mousemove',e=>{if(!dragging)return;const r=canvas.getBoundingClientRect();const mx=(e.clientX-r.left)*(canvas.width/r.width);const my=(e.clientY-r.top)*(canvas.height/r.height);state.cap.x=mx-dragOff.x;state.cap.y=my-dragOff.y;render();});
    window.addEventListener('mouseup',()=>dragging=false);

    scaleInput.addEventListener('input',()=>{state.cap.scale=parseFloat(scaleInput.value||'1');render();});
    rotateInput.addEventListener('input',()=>{state.cap.rot=parseFloat(rotateInput.value||'0');render();});
    opacityInput.addEventListener('input',()=>{state.cap.alpha=parseFloat(opacityInput.value||'1');render();});

    resetBtn.addEventListener('click',()=>{centerCap(state.capImg||presets.cap1);render();});
    dlBtn.addEventListener('click',()=>{const opt=exportSizeSel.value;if(opt==='orig'){const link=document.createElement('a');link.download='avatar.png';link.href=canvas.toDataURL('image/png');link.click();return;}const size=parseInt(opt,10);const off=document.createElement('canvas');off.width=size;off.height=size;const g=off.getContext('2d');if(state.bgImg){g.drawImage(state.bgImg,0,0,size,size);}else{g.fillStyle='#07120f';g.fillRect(0,0,size,size);}const kx=size/canvas.width,ky=size/canvas.height;const k=Math.min(kx,ky);const capSource=state.capImg||presets.cap1;const{x,y,w,h,scale,rot,alpha}=state.cap;const cw=w*scale*k,ch=h*scale*k;const cx=(x*k)+cw/2,cy=(y*k)+ch/2;g.save();g.translate(cx,cy);g.rotate(rot*Math.PI/180);g.globalAlpha=alpha;g.drawImage(capSource,-cw/2,-ch/2,cw,ch);g.restore();const link=document.createElement('a');link.download='avatar.png';link.href=off.toDataURL('image/png');link.click();});

    pickPhotoBtn.addEventListener('click',()=>photoInput.click());
    photoInput.addEventListener('change',async()=>{const f=photoInput.files?.[0];if(!f)return;const img=await loadImageFromFile(f);state.bgImg=img;fitCanvasToImage(img);centerCap(state.capImg||presets.cap1);render();});

    thumbs.addEventListener('click',e=>{const box=e.target.closest('.thumb');if(!box)return;const key=box.getAttribute('data-mask');if(!key)return;state.capImg=presets[key];centerCap(state.capImg);Array.from(thumbs.querySelectorAll('.thumb')).forEach(t=>t.classList.remove('active'));box.classList.add('active');render();});

    window.addEventListener('keydown',e=>{const step=e.shiftKey?10:2;let changed=true;if(e.key==='ArrowLeft')state.cap.x-=step;else if(e.key==='ArrowRight')state.cap.x+=step;else if(e.key==='ArrowUp')state.cap.y-=step;else if(e.key==='ArrowDown')state.cap.y+=step;else if(e.key===']')state.cap.rot+=1;else if(e.key==='[')state.cap.rot-=1;else if(e.key==='+'){state.cap.scale=Math.min(3,state.cap.scale+0.02);scaleInput.value=state.cap.scale;}else if(e.key==='-'){state.cap.scale=Math.max(0.2,state.cap.scale-0.02);scaleInput.value=state.cap.scale;}else changed=false;if(changed){e.preventDefault();render();}});

    centerCap(presets.cap1);render();
  </script>
</body>
</html>
